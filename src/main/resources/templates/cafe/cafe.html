<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
    <!--ë¶€íŠ¸ìŠ¤íŠ¸ë©1-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <meta charset="UTF-8"/>
    <title>cafe map</title>
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© 3. jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!-- css ì ìš© -->
    <style>
        .cafe-list table {
            width: 100%; /* í…Œì´ë¸” ë„ˆë¹„ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶¤ */
            border-collapse: collapse; /* í…Œë‘ë¦¬ ì¤‘ì²© ì œê±° */
            border: 1px solid black; /* í…Œì´ë¸” ì™¸ê³½ì„  ì¶”ê°€ */
        }

        .cafe-list th, .cafe-list td {
            text-align: left; /* í…ìŠ¤íŠ¸ë¥¼ ì™¼ìª½ ì •ë ¬ */
            padding: 8px; /* ì…€ ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
            border: 1px solid black; /* ì…€ ê²½ê³„ì„  ì¶”ê°€ */
        }

        .cafe-list thead th {
            position: sticky;
            top: 0;
            z-index: 2;
        / background-color: #f2f2f2;
            font-weight: bold; /* ê¸€ì”¨ êµµê²Œ */
            border: 1px solid black;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* í—¤ë”ì— ê·¸ë¦¼ì ì¶”ê°€ */
        }

        .modal-body-container {
            display: flex; /* Flexboxë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ë¡œ ì •ë ¬ */
            justify-content: space-between; /* ì–‘ìª½ì— ì—¬ë°±ì„ ë§Œë“¦ */
            align-items: center; /* ì„¸ë¡œ ì¶•ì—ì„œ ì •ë ¬ */
            padding: 10px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
        }

        .modal-body {
            flex: 1; /* ë‚´ìš© ì˜ì—­ì´ ë‚¨ëŠ” ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            padding: 10px; /* ë‚´ìš©ê³¼ ì´ë¯¸ì§€ ê°„ ì—¬ë°± ì¶”ê°€ */
        }

        .modal-body2 {
            flex: 0 0 auto; /* ì´ë¯¸ì§€ ì˜ì—­ì€ ê³ ì • í¬ê¸°ë¡œ ì„¤ì • */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        #modal_cafe_picture {
            width: 26vh;
            height: 26vh;
            border-radius: 5px; /* ì´ë¯¸ì§€ ëª¨ì„œë¦¬ë¥¼ ë‘¥ê¸€ê²Œ */
            object-fit: cover; /* ì´ë¯¸ì§€ë¥¼ ì˜ë¼ë‚´ì§€ ì•Šê³  ë¹„ìœ¨ ìœ ì§€ */
        }

        .customoverlay {
            background: white;
            border: 1px solid black;
            padding: 2px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }

        #map {
            overflow: visible;
            display: block;
            margin-top: 30px;
            width: 60vh;
            height: 50vh;
            margin-left: auto;
            margin-right: auto;
            border-radius: 15px;
            border: 2px solid #ddd;

        }

        .cafe-list table {
            width: 100%; /* í…Œì´ë¸” ë„ˆë¹„ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶¤ */
            border-collapse: collapse; /* í…Œë‘ë¦¬ ì¤‘ì²© ì œê±° */
        }

        .cafe-list th, .cafe-list td {
            text-align: left; /* í…ìŠ¤íŠ¸ë¥¼ ì™¼ìª½ ì •ë ¬ */
            padding: 8px; /* ì…€ ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
            border: 1px solid black; /* ì…€ ê²½ê³„ì„  ì¶”ê°€ */
            /* white-space: nowrap; !* ë‚´ìš©ì´ í•œ ì¤„ë¡œ í‘œì‹œë˜ë„ë¡ ì„¤ì • *!*/
        }

        .cafe-list #tablename, #tableaddr, #tableno {
            font-size: 13px;
            width: 23.3vh;
        }

        .cafe-list th {
            background-color: #f2f2f2; /* í—¤ë” ë°°ê²½ìƒ‰ ì§€ì • */
            font-weight: bold; /* í—¤ë” í°íŠ¸ êµµê²Œ */
        }

        .cafe-list td {
            text-overflow: ellipsis; /* ë‚´ìš©ì´ ê¸¸ë©´ ìƒëµ ê¸°í˜¸ ì¶”ê°€ */
            overflow: hidden;
        }

        .cafe-list {
            display: block;
            width: 70vh;
            height: 30vh;
            margin-left: auto;
            margin-right: auto;
            margin-top: 30px;
            overflow-y: scroll;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .cafe-list::-webkit-scrollbar {
            display: none;
        }

        .cafe-list-size p {
            border: solid 1px black;
            background-color: white;
            color: black;
            margin: 5px 3px;
            cursor: pointer;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f9f0;
        }

        .carousel-item img {
            width: 200px;
            height: 200px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2)
        }

        .carousel-item-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
        }

        .carousel-item-content img {
            flex: 1;
            max-width: 45%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .menu-details {
            flex: 1;
            padding-left: 15px;
        }

        .menu-details p {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
        }

    </style>
</head>
<body>
    <!--ë¶€íŠ¸ìŠ¤íŠ¸ë©2-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <!--&lt;!&ndash; ë¶€íŠ¸ìŠ¤íŠ¸ë© 3. jQuery &ndash;&gt;
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
-->
    <!-- ë ˆì´ì•„ì›ƒ1. -->
    <div layout:fragment="content">

        <!-- ëª¨ë‹¬ í˜•íƒœ.1   -->
        <div class="modal fade" id="cafeModal" tabindex="-1" aria-labelledby="cafeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="modal_cafe_title"></h4>
                    </div>
                    <div class="modal-body-container">
                        <!-- í…ìŠ¤íŠ¸ ì˜ì—­ -->
                        <div class="modal-body">
                            <p id="modal_cafe_Addr"></p>
                            <p id="modal_cafe_Num"></p>
                            <p id="modal_cafe_open"></p>
                            <p id="modal_cafe_close"></p>
                        </div>

                        <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
                        <div class="modal-body2">
                            <img src="" id="modal_cafe_picture" alt="ì¹´í˜ ì´ë¯¸ì§€">
                        </div>
                    </div>
                    <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner" style="border-radius: 10px">
                            <div class="carousel-item active">
                                <div class="carousel-item-content">
                                    <img src="" class="d-block w-50" alt="..." id="menu1">
                                    <div class="menu-details">
                                        <p id="menu1-name"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <div class="carousel-item-content">
                                    <img src="" class="d-block w-50" alt="..." id="menu2">
                                    <div class="menu-details">
                                        <p id="menu2-name"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <div class="carousel-item-content">
                                    <img src="" class="d-block w-50" alt="..." id="menu3">
                                    <div class="menu-details">
                                        <p id="menu3-name"></p>
                                    </div>
                                </div>
                            </div>
                            <div><hr></div>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls"
                                data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls"
                                data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="modalClose" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°
                        </button>
                        <button type="button" class="btn btn-primary">ì˜ˆì•½</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì§€ë„ ì˜ì—­ -->
        <div id="map"></div>

        <!-- ì¹´ì¹´ì˜¤ë§µ í‚¤ -->
        <script type="text/javascript"
                src="//dapi.kakao.com/v2/maps/sdk.js?appkey=664e6d5a215c422f526fcfa59d68b671&libraries=services"></script>
        <script>
            <!--ë§µ ì„ ì–¸ê³¼  ì´ˆê¸°ìœ„ì¹˜  -->

            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(37.498095, 127.027610),
                level: 6
            };
            var map = new kakao.maps.Map(container, options);

            $(document).ready(function () {
                const markers = [];
                const customOverlays = [];
                const menulists = [];

                $.ajax({
                    url: "/cafe/map/menu/",
                    type: "get",
                    dataType: "json",
                    success: function (response) {
                        menulists.push(...response)

                    }
                });

                //ì˜¤ë²„ë ˆì´ì™€ ë§ˆì»¤ë¥¼ í†µí•´ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
                $.ajax({
                    url: "/cafe/map/",
                    type: "get",
                    dataType: "json",
                    success: function (response) {
                        response.forEach(function (cafe) {

                            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
                            var imageSize = new kakao.maps.Size(24, 35);
                            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                            const cafeMenus = menulists
                                .filter(menu => menu.cafeId === cafe.cafeId) // ì¹´í˜ IDì™€ ë©”ë‰´ ë§¤ì¹­
                                .slice(0, 3); //
                            const menuImg = cafeMenus.map(menu => `${menu.menuPictureGenerated}`)
                            const menuHtml = cafeMenus.map(menu => `<li>${menu.menuName}</li>`).join("");

                            var marker = new kakao.maps.Marker({
                                map: map,
                                position: new kakao.maps.LatLng(cafe.cafeLatitude
                                    , cafe.cafeLongtitude),
                                title: cafe.cafeName,
                                image: markerImage
                            });

                            <!--ê²½ë¡œ-->
                            var imagePath = `/images/cafe/${cafe.cafePictureGenerated}`;

                            var content = `
                                             <div class="customoverlay" style="background: white; border: 1px solid black; padding: 5px; border-radius: 5px;">
                                                    <p>${cafe.cafeName}</p>
                                                    <ul>${menuHtml}</ul>
                                              </div>
                                                                            `;

                            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                            var customOverlay = new kakao.maps.CustomOverlay({
                                map: map,
                                position: marker.getPosition(),
                                content: content,
                                yAnchor: 1.3,
                            });

                            //ë§ˆì»¤, ì˜¤ë²„ë ˆì´ ì €ì¥
                            markers.push({marker: marker, data: cafe});
                            customOverlays.push(customOverlay);

                            // ëª¨ë‹¬ ìƒì„±
                            var cafeModal = new bootstrap.Modal(document.getElementById('cafeModal'));

                            document.getElementById("modalClose").addEventListener("click", function () {
                                cafeModal.hide();
                            });

                            // 1. ë§ˆì»¤ í´ë¦­
                            kakao.maps.event.addListener(marker, 'click', function () {
                                closeAllOverlays();
                                cafeModal.show();
                                // ëª¨ë‹¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                                document.getElementById("modal_cafe_title").innerHTML = cafe.cafeName;
                                document.getElementById("modal_cafe_Addr").innerText = `ğŸ“ ì£¼ì†Œ: ${cafe.cafeAddr || "ì •ë³´ ì—†ìŒ"}`;
                                document.getElementById("modal_cafe_Num").innerText = `ğŸ“ ì—°ë½ì²˜: ${cafe.cafeNo || "ì •ë³´ ì—†ìŒ"}`;
                                document.getElementById("modal_cafe_open").innerText = `â° ì˜¤í”ˆ ì‹œê°„: ${cafe.cafeOpenHour || "ì •ë³´ ì—†ìŒ"}`;
                                document.getElementById("modal_cafe_close").innerText = `â° ë§ˆê° ì‹œê°„: ${cafe.cafeCloseHour || "ì •ë³´ ì—†ìŒ"}`;
                                var imagePath = `/images/cafe/${cafe.cafePictureGenerated}`;
                                document.getElementById("modal_cafe_picture").src = imagePath;

                                const carouselInner = document.querySelector(".carousel-inner");
                                carouselInner.innerHTML = ""; // ê¸°ì¡´ ìºëŸ¬ì…€ ì½˜í…ì¸  ì´ˆê¸°í™”

                                // ë©”ë‰´ ë°ì´í„° ë§¤í•‘
                                const cafeMenus = menulists.filter(menu => menu.cafeId === cafe.cafeId);

                                cafeMenus.forEach((menu, index) => {
                                    const carouselItem = document.createElement("div");
                                    carouselItem.classList.add("carousel-item");
                                    if (index === 0) carouselItem.classList.add("active");

                                    const contentDiv = document.createElement("div");
                                    contentDiv.classList.add("carousel-item-content");

                                    const imgElement = document.createElement("img");
                                    imgElement.src = `/images/menu/${menu.menuPictureGenerated}`;
                                    imgElement.classList.add("d-block", "w-50");

                                    <!-- ë©”ë‰´ ì´ë¦„-->
                                    const detailsDiv = document.createElement("div");
                                    detailsDiv.classList.add("menu-details");

                                    const nameElement = document.createElement("p");
                                    nameElement.innerText = `${menu.menuName} ğŸ°`;

                                    detailsDiv.appendChild(nameElement);

                                    contentDiv.appendChild(imgElement);
                                    contentDiv.appendChild(detailsDiv);
                                    carouselItem.appendChild(contentDiv);
                                    carouselInner.appendChild(carouselItem);
                                });

                            });

                            // 2. ë§ˆì»¤ì— mouseover ë“±ë¡í•©ë‹ˆë‹¤
                            kakao.maps.event.addListener(marker, 'mouseover', function () {
                                // ë§ˆì»¤ ìœ„ì— ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
                                customOverlay.setMap(map);
                                /* infowindow.open(map, marker);  */
                            })

                            // 3. mouseout
                            kakao.maps.event.addListener(marker, 'mouseout', function () {
                                customOverlay.setMap(null);
                                /*  infowindow.close();*/
                            });

                            // ëª¨ë‘ ë‹«ê¸° ê¸°ëŠ¥
                            function closeAllOverlays() {
                                customOverlay.setMap(null);
                            }

                            closeAllOverlays();
                        })
                        updateCafeList();
                    }
                });

                kakao.maps.event.addListener(map, 'drag', updateCafeList);

                function closeAllOverlays() {
                    customOverlay.setMap(null);
                }

                function updateCafeList() {
                    const bounds = map.getBounds();
                    const visibleCafes = markers.filter(function (item) {
                        return bounds.contain(item.marker.getPosition());
                    });

                    const cafeListElement = $("#mycafeList");
                    cafeListElement.empty();
                    visibleCafes.forEach(function (item) {
                        const cafeMenus = menulists
                            .filter(menu => menu.cafe_id === item.data.cafe_id) // ë©”ë‰´ì™€ ì¹´í˜ ë§¤ì¹­
                            .slice(0, 3);

                        const menuHtml = cafeMenus.map(menu => `<li>${menu.menu_name}</li>`).join("");

                        const cafeRow = `
                                            <tr>
                                               <td class="cafename">${item.data.cafeName}</td>
                                                <td class="cafeaddr">${item.data.cafeAddr}</td>
                                                <td class="cafeno">${item.data.cafeNo}</td>
                                             </tr>
                                                        `;
                        cafeListElement.append(cafeRow);
                    });
                }
            });
        </script>
        </script>
        <!-- ì¹´í˜ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
        <div class="cafe-list">
            <table>
                <thead>
                <tr>
                    <th id="tablename">ì´ë¦„</th>
                    <th id="tableaddr">ì£¼ì†Œ</th>
                    <th id="tableno">ë²ˆí˜¸</th>
                </tr>
                </thead>
                <tbody id="mycafeList">
                </tbody>
                <!-- ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
            </table>
        </div>
    </div>
</body>
</html>